<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë²”ì£„êµ­ ì¶œêµ­ì ë¹„ìœ¨ ë¶„ì„</title>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background: #fafafa;
            padding: 30px;
            color: #222;
        }
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        h2 {
            margin-top: 40px;
            font-size: 24px;
        }
        #charts {
            display: flex;
            flex-direction: column;
            gap: 70px;
        }
        .chart-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
    </style>
</head>

<body>
    <h1>ğŸ“Š ë²”ì£„êµ­ ì¶œêµ­ì ë¹„ìœ¨(%) ê¸°ë°˜ ë²”ì£„ ë°œìƒ ë¶„ì„</h1>
    <p>Â· Django APIì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì‹œê°í™”í•©ë‹ˆë‹¤.</p>

    <div id="charts">
        <div class="chart-box">
            <h2>â‘  ë²”ì£„êµ­ ì¶œêµ­ ë¹„ìœ¨ vs ì‚¬ì´ë²„ì‚¬ê¸° ë°œìƒê±´ìˆ˜</h2>
            <div id="chart_scam" style="width:100%;height:550px;"></div>
        </div>

        <div class="chart-box">
            <h2>â‘¡ ë²”ì£„êµ­ ì¶œêµ­ ë¹„ìœ¨ vs ë³´ì´ìŠ¤í”¼ì‹± ë°œìƒê±´ìˆ˜</h2>
            <div id="chart_voice" style="width:100%;height:550px;"></div>
        </div>
    </div>

    <script>
        // ì„ í˜• íšŒê·€ ê³„ì‚° í•¨ìˆ˜
        function linearRegression(x, y) {
            const n = x.length;
            const sumX = x.reduce((a,b)=>a+b, 0);
            const sumY = y.reduce((a,b)=>a+b, 0);
            const sumXY = x.map((xi,i) => xi * y[i]).reduce((a,b)=>a+b, 0);
            const sumX2 = x.map(v => v*v).reduce((a,b)=>a+b, 0);

            // slope = ê¸°ìš¸ê¸°, intercept = ì ˆí¸
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX ** 2);
            const intercept = (sumY - slope * sumX) / n;

            return { slope, intercept };
        }

        // Django API í˜¸ì¶œ
        fetch("/analysis/data/")
            .then(res => res.json())
            .then(data => {
                const years = data.years;
                const ratio = data.crime_ratio;
                const cyber = data.cyber_scam_cases;
                const voice = data.voice_phishing_cases;

                drawCyberChart(years, ratio, cyber);
                drawVoiceChart(years, ratio, voice);
            });

        // -------------------------------
        // â‘  ì‚¬ì´ë²„ì‚¬ê¸° ê·¸ë˜í”„
        // -------------------------------
        function drawCyberChart(years, ratio, cases) {

            const lr = linearRegression(ratio, cases);
            const lineX = [Math.min(...ratio), Math.max(...ratio)];
            const lineY = lineX.map(x => lr.slope * x + lr.intercept);

            Plotly.newPlot("chart_scam", [
                {
                    x: ratio,
                    y: cases,
                    mode: "markers+text",
                    type: "scatter",
                    text: years.map(String),
                    textposition: "top center",
                    marker: { size: 12, color: "#ff4d4d" }
                },
                {
                    x: lineX,
                    y: lineY,
                    mode: "lines",
                    line: { color: "black" },
                    name: `íšŒê·€ì„ : y = ${lr.slope.toFixed(3)}x + ${lr.intercept.toFixed(1)}`
                }
            ], {
                title: "ë²”ì£„êµ­ ì¶œêµ­ì ë¹„ìœ¨ vs ì‚¬ì´ë²„ì‚¬ê¸°",
                xaxis: { title: "ì¶œêµ­ì ë¹„ìœ¨ (%)" },
                yaxis: { title: "ì‚¬ì´ë²„ì‚¬ê¸° ë°œìƒê±´ìˆ˜" }
            });
        }

        // -------------------------------
        // â‘¡ ë³´ì´ìŠ¤í”¼ì‹± ê·¸ë˜í”„
        // -------------------------------
        function drawVoiceChart(years, ratio, cases) {

            const lr = linearRegression(ratio, cases);
            const lineX = [Math.min(...ratio), Math.max(...ratio)];
            const lineY = lineX.map(x => lr.slope * x + lr.intercept);

            Plotly.newPlot("chart_voice", [
                {
                    x: ratio,
                    y: cases,
                    mode: "markers+text",
                    type: "scatter",
                    text: years.map(String),
                    textposition: "top center",
                    marker: { size: 12, color: "#ff884d" }
                },
                {
                    x: lineX,
                    y: lineY,
                    mode: "lines",
                    line: { color: "black" },
                    name: `íšŒê·€ì„ : y = ${lr.slope.toFixed(3)}x + ${lr.intercept.toFixed(1)}`
                }
            ], {
                title: "ë²”ì£„êµ­ ì¶œêµ­ì ë¹„ìœ¨ vs ë³´ì´ìŠ¤í”¼ì‹±",
                xaxis: { title: "ì¶œêµ­ì ë¹„ìœ¨ (%)" },
                yaxis: { title: "ë³´ì´ìŠ¤í”¼ì‹± ë°œìƒê±´ìˆ˜" }
            });
        }
    </script>

</body>
</html>
